<analysis>**original_problem_statement**: The initial request from the previous fork was to fix duplicate matches appearing on the frontend. During this session, the user reported several additional high-priority bugs:
1.  A Draw column was incorrectly appearing for basketball matches.
2.  The odds bookmaker table headers were missing team names for sorting (this turned out to be a misunderstanding).
3.  Duplicate UI elements (score, time) were appearing within a single match card.
4.  Mobile formatting was broken after fixing the duplicate elements.
5.  The countdown timer was removed, but the user wanted a simple LIVE or FINAL badge instead.
6.  Live matches were showing VS instead of a score (e.g., 0-0).
7.  FunBet IQ scores were missing from the FunBet IQ History page.
8.  A critical flaw in prediction integrity was discovered: FunBet IQ was being calculated for matches that had already started.
9.  The historical track record (last 30 days) was empty, requiring a backfill of IQ scores.
10. Stale odds from certain bookmakers (like Bovada) were corrupting the live odds display and FunBet.me's 5% markup calculation.

**User's preferred language**: English

**what currently exists?**
A full-stack sports analytics application (React/FastAPI/MongoDB) that displays and analyzes sports odds. The app features a FunBet IQ v4 prediction engine.

Key fixes and features from this session include:
- The UI now correctly handles basketball matches (no Draw column).
- Match cards have been cleaned up to remove duplicate score/time displays and now use a simple LIVE/FINAL badge system.
- Live matches correctly display a score (e.g., 0-0) instead of VS.
- The FunBet IQ History page now correctly displays the pre-match IQ scores for each completed prediction.
- **CRITICAL**: The prediction integrity logic in  was fixed to ensure pre-match predictions are **strictly pre-match only**, by adding checks to skip matches that are already live or completed. 306 invalid historical predictions were deleted with user permission.
- A temporary backfill mode was implemented and used to populate historical data, which is now complete. The system is back in normal live mode.
- A sophisticated filtering mechanism has been added to the backend () to remove bookmakers with stale odds from live match displays, protecting the accuracy of the best-odds highlighting and the FunBet.me markup.

**Last working item**:
-   **Last item agent was working**: Implementing an advanced stale odds filtering logic for live games, as specified by the user. The new logic, added to , is: after a match has been live for 7 minutes, start monitoring bookmaker odds. If a bookmaker's odds do not change for 3 consecutive checks (which occur every 2 minutes, totaling a 6-minute window), they are filtered out from the API response for that specific live match.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: backend testing agent (to verify the new filtering logic by simulating stale odds and checking the  endpoint response).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: The new stale odds filtering logic needs to be tested and verified. (Priority: P0)

**Issues Detail**:
-   **Issue 1**:
    -   **Description**: The agent implemented a new, complex rule to filter out stale bookmakers from live odds. This logic resides in . It needs to be confirmed that the backend was restarted and that the logic works as intended.
    -   **Attempted fixes**: The agent wrote the code in  based on the user's instructions.
    -   **Next debug checklist**:
        1.  Restart the backend service to apply the latest changes in  (backend: stopped
backend: started).
        2.  Identify a live match from the  endpoint.
        3.  Manually inspect the  timestamps for bookmakers of that live match in the  collection in MongoDB.
        4.  Verify that bookmakers whose odds haven't been updated for more than ~6-7 minutes are being excluded from the  array for that match in the API response.
    -   **Why fix this issue and what will be achieved with the fix?**: This ensures the live odds comparison is always based on fresh data, making the best odds feature and the FunBet.me markup accurate.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P1) Frontend Component Refactor**: The match display logic is duplicated in  and . This code should be refactored into a single, reusable  component to improve maintainability.
-   **Future Tasks**:
    -   **Improve Live Score Linking Robustness**: The deployment logs in the previous session showed many Could not link warnings. The fuzzy matching logic in  that links odds data to live score data is still failing for some teams.
    -   **Expanded Cricket Odds Coverage**: Integrate a dedicated cricket odds provider to increase data volume, as The Odds API has limited cricket availability.

**Completed work in this session**
-   **UI Bug Fixes**:
    -   Removed the Draw column for all basketball matches across the app (, ).
    -   Removed duplicate score/time display from match cards.
    -   Replaced complex countdown timer with a simple / badge.
    -   Fixed live matches to show a score (e.g., 0-0) instead of VS.
-   **FunBet IQ Fixes**:
    -   **CRITICAL (Prediction Integrity)**: Fixed the engine to prevent IQ calculation for matches already live or completed. Invalid historical data was purged.
    -   **IQ History Page**: Restored the missing display of Home/Draw/Away IQ scores on the  history page.
-   **Data Integrity Fixes**:
    -   **Bookmaker Deduplication**: Fixed a bug where duplicate bookmaker entries (e.g., Betfair) were being stored for a single match.
    -   **Stale Odds Filtering**: Implemented a robust system to filter out bookmakers with stale odds from live match API responses.
-   **Process & Documentation**:
    -   Successfully executed a backfill of IQ scores for the last 30 days of matches.
    -   Created multiple documentation files (, ) to prevent recurring issues, like database name confusion, for future agents.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: Intermittent live score linking failures due to fuzzy matching.
    -   **Debug checklist**: Log team names from The Odds API and the score provider for failed links to analyze discrepancies and improve  logic.
    -   **Why to solve this issue and what will be achieved with this?**: To maximize live score coverage across all sports.
    -   **Should Test frontend/backend/both after fix**: Backend
    -   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Confusion over the correct MongoDB database name ( vs. ). The agent's test scripts were using the wrong name.
-   **Recurrence count**: 2+
-   **Status**: RESOLVED (Agent created multiple documentation files and notes to explicitly state the correct database name is **funbet** as defined in ).

**Code Architecture**


**Key Technical Concepts**
-   **Frontend**: React, , shadcn/ui
-   **Backend**: FastAPI, Pydantic, MongoDB ( for async), 
-   **Data Matching**:  library for fuzzy string matching.

**key DB schema**
-   : Stores match data from The Odds API.
-   : Stores historical FunBet IQ records. Now includes a  flag to differentiate pre-match predictions from those calculated during a live game.
-   , : Collections for historical data.

**changes in tech stack**
-   None.

**All files**
-   **Updated**:
    -   : Major changes to fix basketball Draw column, remove duplicate score displays, replace timer with a simple badge, and fix live scores showing VS.
    -   : Mirrored the UI fixes from .
    -   : Added the missing IQ score display to the history tab.
    -   : **CRITICAL CHANGE**. Added logic to prevent IQ calculation for live/completed matches. Temporarily removed this check for backfill, then re-added it. Added  flag.
    -   : Added logic to de-duplicate bookmakers before saving to the database.
    -   : **CRITICAL CHANGE**. Added logic to filter out bookmakers with stale odds from the  response for live matches.
-   **Created**:
    -   : Note for future agents about the correct DB name.
    -   : Explicit policy to never delete data without user consent.
    -   : A summary document.
    -   Various other  files for documentation and temporary verification scripts.

**Areas that need refactoring**:
-   The match display logic is duplicated across  and . It should be extracted into a single  component.

**key api endpoints**
-   : The main endpoint for fetching all match data. It now includes logic to filter out stale bookmakers for live games.
-   : Endpoint for the FunBet IQ history page.

**Critical Info for New Agent**
-   **User Communication**: The user is highly technical, direct, and expects fast, accurate results. Validate your understanding frequently with screenshots.
-   **Database Name is **: The application uses the  database, as specified in . All your scripts and checks must use this database name. Do not use .
-   **Prediction Integrity is Paramount**: For a prediction to be included in the official verified track record, its FunBet IQ **must** be calculated **before** the match starts. The  now enforces this. IQ can be calculated for live games, but it's flagged with  and should not be part of the official accuracy stats.
-   **Stale Live Odds Filtering**: The logic in  to remove stale bookmakers from live games is new and critical. The next agent must verify it's working correctly.
-   **Data Preservation**: **DO NOT DELETE DATA** from any collection without explicit user permission. The user confirmed the deletion of 306 invalid predictions, but this is an exception.

**documents created in this job**
-   
-   
-   
-   
-   
-   

**Last 5 User Messages and any pending user messages**
1.  **User**: Pointed out that FunBet.me's 5% markup calculation was incorrect for live games due to stale odds. **Status: IN PROGRESS**.
2.  **User**: Confirmed that the correct odds for a 90-minute 2-1 game should be ~1.01 for the winning team. **Status: ADDRESSED**.
3.  **User**: Proposed a new, more dynamic logic for filtering stale live odds (start checking at 7 mins, remove after 3 failed checks over 6 mins). **Status: IMPLEMENTED, PENDING TESTING**.
4.  **User**: Noted that the stats shown in a screenshot (301 verified) didn't match the agent's report and asked for an accurate count of matches by sport for the past/next 30 days. **Status: ADDRESSED**.
5.  **User**: Asked why football coverage wasn't 100%. **Status: ADDRESSED** (Explained the 2 missing matches were live and correctly skipped by the backfill).

**Project Health Check:**
-   **Broken**: None.
-   **Mocked**: None.

**Testing status**
-   **Testing agent used after significant changes**: NO (Agent performed rapid bug fixes using screenshots and manual verification).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Numerous temporary Python scripts for verification (e.g., , ).
-   **Known regressions**: None.

**Credentials to test flow:**
-   **Admin Login**:  /  (configurable via / in ).

**What agent forgot to execute**
-   The planned refactor of  and  into a reusable  component has not been started.
-   The recurring issue of improving the fuzzy matching for team name linking was not addressed in this session.</analysis>
